name: auto-release

on:
  push:
    branches:
      - master
    paths-ignore:
      - "package.json"

jobs:
  semver:
    runs-on: ubuntu-latest
    steps:
      # Drafts your next Release notes as Pull Requests are merged into "master"
      - uses: release-drafter/release-drafter@v5
        with:
          publish: false
          prerelease: false
          config-name: auto-release-config.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  testpackageupdate:
    runs-on: ubuntu-latest
    steps:
      - uses: oleksiyrudenko/gha-git-credentials@v2.1
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
      - name: Checkout Source
        id: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set NPM package version
        id: set_npm_package_version
        env:
          ARTIFACTORY_USERNAME: ${{ secrets.CORPDEV_ARTIFACTORY_USERNAME }}
          ARTIFACTORY_TOKEN: ${{ secrets.CORPDEV_ARTIFACTORY_TOKEN }}
        shell: bash
        run: |
          npm version --allow-same-version 1.7.0
          git add "./*package.json" #Gets all package.json files which might have been modified
          git commit -m "Update NPM package(s) version"
          git push

  # updatepackage:
  #   needs: [semver]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v2
  #     - name: Bump version
  #       id: version
  #       uses: vemel/nextversion@main
  #       with:
  #         path: ./package.json
  #         type: semver
  #         result: ${{ github.event.inputs.bump }}
  #         release: ${{ needs.semver.name }}
  #         update: |
  #           ./package.json
  #     - name: Create Package.json Pull Request
  #       uses: peter-evans/create-pull-request@v3
  #       with:
  #         commit-message: update package.json
  #         title: Update Package.json
  #         body: Update the package.json version to match the release
  #         branch: update-package-json
  #         base: master

  # changelog:
  #   needs: [semver]
  #   runs-on: ubuntu-latest

  #   strategy:
  #     matrix:
  #       node-version: [14.x]
  #       # See supported Node.js release schedule at https://nodejs.org/en/about/releases/

  #   steps:
  #     - uses: actions/checkout@v2
  #       with:
  #         fetch-depth: 0
  #     - name: Cache node modules
  #       uses: actions/cache@v2
  #       env:
  #         cache-name: cache-node-modules
  #       with:
  #         # npm cache files are stored in `~/.npm` on Linux/macOS
  #         path: ~/.npm
  #         key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
  #         restore-keys: |
  #           ${{ runner.os }}-build-${{ env.cache-name }}-
  #           ${{ runner.os }}-build-
  #           ${{ runner.os }}-
  #     - name: Use Node.js ${{ matrix.node-version }}
  #       uses: actions/setup-node@v1
  #       with:
  #         node-version: ${{ matrix.node-version }}
  #     - run: npm ci
  #     - run: npm run changelog
  #     - name: Create Changelog Pull Request
  #       uses: peter-evans/create-pull-request@v3
  #       with:
  #         commit-message: update changelog
  #         title: Update Changelog
  #         body: Update changelog to reflect release changes
  #         branch: update-changelog
  #         base: master
    env:
      ARTIFACTORY_TOKEN: "${{ secrets.CORPDEV_ARTIFACTORY_TOKEN }}"
      ARTIFACTORY_USERNAME: "${{ secrets.CORPDEV_ARTIFACTORY_USERNAME }}"
      ARTIFACTORY_PASSWORD: "${{ secrets.CORPDEV_ARTIFACTORY_PASSWORD }}"
